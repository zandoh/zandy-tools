name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate Addon Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check main addon TOC
        run: |
          if [ ! -f "ZandyTools/ZandyTools.toc" ]; then
            echo "Error: ZandyTools/ZandyTools.toc not found"
            exit 1
          fi
          echo "TOC file found"

      - name: Validate TOC format
        run: |
          if ! grep -q "## Interface:" ZandyTools/ZandyTools.toc; then
            echo "Error: TOC missing Interface version"
            exit 1
          fi
          echo "TOC file format valid"

      - name: Check core files
        run: |
          files=("ZandyTools/Main.lua" "ZandyTools/Core/Init.lua" "ZandyTools/Core/ModuleLoader.lua" "ZandyTools/Core/Database.lua" "ZandyTools/Core/Config.lua")
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Error: $file not found"
              exit 1
            fi
          done
          echo "All core files present"

      - name: Check module addon
        run: |
          if [ ! -f "ZandyTools_RoleCheck/ZandyTools_RoleCheck.toc" ]; then
            echo "Error: RoleCheck module TOC not found"
            exit 1
          fi
          echo "Module addon found"

  package-test:
    name: Test Package Creation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install packager
        run: |
          curl -s https://raw.githubusercontent.com/BigWigsMods/packager/master/release.sh -o release.sh
          chmod +x release.sh

      - name: Create test package
        run: ./release.sh -d -z
